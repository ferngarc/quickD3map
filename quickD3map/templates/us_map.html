{% extends "layout.html" %}


{% block body %}

		 
		 {% if columns%}
			 <select id="select" >
				 {% for col in columns %}
		             <option value="{{col}}"> {{col}} </option>
		         {% endfor %}
		     </select>
		 {% endif %}
		 
 		 <div id="map">
 		</div>
{% endblock %}


{% block script %}
<script>
	var width = Math.max({{ width }}, window.innerWidth);
	var height = Math.max({{ height }}, window.innerHeight);
    var samples = {{geojson|string|safe}};
    var geojson = {{map_data|string|safe}};
    var radius = d3.scale.sqrt()
        .domain([0, 1e{{scale_exp}}])
        .range([0, 10]);

    //{{ projection }}
    //{{ svg }}

    var projection = d3.geo.albers()
		{% if center %}
			 .center( {{center}} )
		{% endif %}
     // .rotate([98,0])
      //.parallels([29.5, 45.5])
      //.center([8, 40])
      //.translate([width/2,height/2])
      .scale(800);

    var path = d3.geo.path()
      .projection(projection);

    var svg = d3.select("#map")
      .append("svg")
      .append("g")
      .attr("width", width)
      .attr("height", height);

    svg.append("path")
          .attr("class", "states")
          .datum(topojson.feature(geojson, geojson.objects.states))
          .attr("d", path);

     svg.selectAll(".symbol")
            .data(samples.features)
            .enter().append("path")
              .attr("class", "symbol")
     .attr("d", path.pointRadius(function(d) { return radius(100) }));

	d3.selectAll("select").on("change", function () {updateSize(this.value) });
	 
    //this is where the update size code goes
    function updateSize(value) {
        // join new data with old elements
        var symbol = svg.selectAll(".symbol")
              .data(samples.features);
        // UPDATE
        symbol.attr("d", path.pointRadius(function(d) { return radius(d.properties[value]); }))

      }
	  
  	function zoomed() {
  		//update project and then the map the points and the lines
  		projection
  		  .scale(zoom.scale() / 2 / Math.PI)
  		  .translate(zoom.translate());

  	 	 map.datum( topojson.feature(geojson, geojson.objects.countries)).attr("d", path);
  	 	 //map.datum( topojson.feature(geojson, geojson.objects.ocean)).attr("d", path);
		 
  		 points.attr("d", path);
		 
  		 //below are lines as line-features which update on zoom
  		 lines.attr("d",path);
		  
  		// lines
  		//     .selectAll(".lines")
  		// 	.data( convert_to_points(line_data)  )
  		// 	.enter()
  		// 	.append("svg:line")
  		// 	    .attr("x1",function(d){return d[0][0]})
  		// 	    .attr("y1",function(d){return d[0][1]})
  		// 	    .attr("x2",function(d){return d[1][0]})
  		// 	    .attr("y2",function(d){return d[1][1]})
  		// 	    .attr("class", "lines");

  	}
	

	  {%- if center is not none -%}
	  	 var center = projection( {{ center }});
	  {% else %}
	       var center = projection([ 0, 20]);
	  {%- endif -%}

		var zoom = d3.behavior.zoom()
		    .scale(projection.scale() * 2 * Math.PI)
		    .scaleExtent([1 << 11, 1 << 14])
		    .translate([width - center[0], height - center[1]])
		    .on("zoom", zoomed);

      svg.call(zoom)
	  
	  
</script>
{% endblock %}
